<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Financiero ARS Pro</title>

    <!-- React 18 Core -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- React Dependencies for Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts (after React dependencies) -->
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        .glass {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-dark {
            backdrop-filter: blur(20px);
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .blob1 {
            position: fixed;
            top: -20%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .blob2 {
            position: fixed;
            bottom: -30%;
            right: -15%;
            width: 700px;
            height: 700px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .blob3 {
            position: fixed;
            top: 40%;
            right: 20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(34, 211, 238, 0.15) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes stagger {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .animate-slide {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .animate-pop {
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-stagger {
            animation: stagger 0.3s ease-out forwards;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .toast {
            animation: slideUp 0.3s ease-out, fadeIn 0.3s ease-out reverse forwards 2.5s;
        }

        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }
    </style>
</head>

<body class="text-white overflow-x-hidden">
    <div class="blob1"></div>
    <div class="blob2"></div>
    <div class="blob3"></div>
    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        const { PieChart, Pie, Cell, AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend } = Recharts;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FASE 1: CONFIGURACI√ìN Y MODELO DE DATOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const firebaseConfig = {
            apiKey: "AIzaSyCiJwLv-jw1EQT3FNT6gdWw2NV51UxvbQU",
            authDomain: "finanzas-44f11.firebaseapp.com",
            projectId: "finanzas-44f11",
            storageBucket: "finanzas-44f11.firebasestorage.app",
            messagingSenderId: "403874855146",
            appId: "1:403874855146:web:1f0bc48e339e06316cff93"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'finanzas-44f11-app';

        // CONSTANTES DE LOS 6 PILARES
        const PILARES = {
            gastos_fijos: { nombre: 'Gastos Fijos', tipo: 'gasto', color: '#f43f5e', icon: 'üè†', subcategorias: ['Renta', 'Agua', 'Luz', 'Gas', 'Internet', 'Celular', 'Netflix'] },
            gastos_variables: { nombre: 'Gastos Variables', tipo: 'gasto', color: '#f97316', icon: 'üõí', subcategorias: ['Personal', 'Moto/Auto', 'Gastos Hormiga', 'Ocio'] },
            tarjetas: { nombre: 'Tarjetas de Cr√©dito', tipo: 'gasto', color: '#a855f7', icon: 'üí≥', subcategorias: ['Visa', 'Mastercard', 'Amex', 'Otro'] },
            ahorro: { nombre: 'Ahorro', tipo: 'ahorro', color: '#3b82f6', icon: 'üè¶', subcategorias: ['Ahorro Fijo', 'Ahorro Variable'] },
            inversiones: { nombre: 'Inversiones IOL', tipo: 'inversion', color: '#06b6d4', icon: 'üìà', subcategorias: ['Acciones', 'Bonos', 'CEDEARs', 'FCIs', 'Cripto'] },
            ingresos: { nombre: 'Ingresos', tipo: 'ingreso', color: '#10b981', icon: 'üí∞', subcategorias: ['Marketing', 'Moto (Uber/Didi)', 'Trabajo Adicional', 'Sueldo', 'Otros'] }
        };

        const TABS = [
            { id: 'dashboard', nombre: 'Resumen', icon: 'üìä' },
            { id: 'gastos', nombre: 'Gastos', icon: 'üí∏' },
            { id: 'tarjetas', nombre: 'Tarjetas', icon: 'üí≥' },
            { id: 'ahorro', nombre: 'Ahorro', icon: 'üè¶' },
            { id: 'inversiones', nombre: 'Inversiones', icon: 'üìà' },
            { id: 'ingresos', nombre: 'Ingresos', icon: 'üí∞' },
            { id: 'analisis', nombre: 'An√°lisis', icon: 'üìâ' }
        ];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ICONOS SVG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 5v14M5 12h14" /></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12" /></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" /></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01" /></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M20 6L9 17l-5-5" /></svg>,
            Loader: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 11-6.219-8.56" /></svg>
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILIDADES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const formatARS = (v) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(v || 0);
        const today = () => new Date().toISOString().split('T')[0];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE PRINCIPAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [activeTab, setActiveTab] = useState(() => localStorage.getItem('activeTab') || 'dashboard');
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [toast, setToast] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [timeFilter, setTimeFilter] = useState('mes');

            const [formData, setFormData] = useState({
                articulo: '', monto: '', fecha: today(), seccion: 'gastos_fijos', subcategoria: 'Renta',
                cuotas: '', cuotaActual: '', diaVencimiento: ''
            });

            // Persistir pesta√±a activa
            useEffect(() => { localStorage.setItem('activeTab', activeTab); }, [activeTab]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // SISTEMA DE ALMACENAMIENTO H√çBRIDO (localStorage + Firebase)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const STORAGE_KEY = 'finanzas_transactions';
            const USER_KEY = 'finanzas_user_uid';

            // Cargar datos de localStorage
            const loadFromLocal = () => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            };

            // Guardar en localStorage
            const saveToLocal = (data) => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) { console.error('Error saving to localStorage:', e); }
            };

            // Auth con persistencia de UID
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (!u) {
                        try {
                            // Intentar usar UID guardado o crear nuevo
                            await auth.signInAnonymously();
                        }
                        catch (e) {
                            console.warn('Firebase auth failed, using local storage only');
                            // Cargar datos locales si Firebase falla
                            setTransactions(loadFromLocal());
                            setLoading(false);
                        }
                    } else {
                        setUser(u);
                        localStorage.setItem(USER_KEY, u.uid);
                    }
                });
                return () => unsub();
            }, []);

            // Firestore listener con fallback a localStorage
            useEffect(() => {
                // Cargar datos locales inmediatamente
                const localData = loadFromLocal();
                if (localData.length > 0) {
                    setTransactions(localData);
                    setLoading(false);
                }

                if (!user) return;

                const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('transactions');
                const unsub = ref.onSnapshot(
                    (snap) => {
                        const firebaseData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setTransactions(firebaseData);
                        // Sincronizar con localStorage
                        saveToLocal(firebaseData);
                        setLoading(false);
                        setError(null);
                    },
                    (err) => {
                        console.warn('Firebase error, using local storage:', err.message);
                        // Si Firebase falla, usar datos locales
                        setTransactions(loadFromLocal());
                        setLoading(false);
                        // No mostrar error, simplemente usar localStorage
                    }
                );
                return () => unsub();
            }, [user]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 3: L√ìGICA CRUD (con soporte localStorage)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const showToast = (msg, type = 'success') => { setToast({ msg, type }); setTimeout(() => setToast(null), 3000); };

            // Generar ID √∫nico local
            const generateId = () => 'local_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const handleSave = async (e) => {
                e.preventDefault();
                if (!formData.articulo || !formData.monto) return;

                const data = {
                    articulo: formData.articulo,
                    monto: parseFloat(formData.monto),
                    fecha: formData.fecha,
                    seccion: formData.seccion,
                    subcategoria: formData.subcategoria,
                    tipo: PILARES[formData.seccion].tipo,
                    timestamp: new Date().toISOString(),
                    ...(formData.seccion === 'tarjetas' && { cuotas: parseInt(formData.cuotas) || 1, cuotaActual: parseInt(formData.cuotaActual) || 1, diaVencimiento: parseInt(formData.diaVencimiento) || 10 })
                };

                // Guardar en localStorage primero (siempre funciona)
                let newTransactions;
                if (editingId) {
                    newTransactions = transactions.map(t => t.id === editingId ? { ...data, id: editingId } : t);
                } else {
                    const newId = generateId();
                    newTransactions = [...transactions, { ...data, id: newId }];
                }
                setTransactions(newTransactions);
                saveToLocal(newTransactions);
                showToast(editingId ? 'Movimiento actualizado' : 'Movimiento guardado');
                resetForm();

                // Intentar sincronizar con Firebase (opcional)
                if (user) {
                    try {
                        const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('transactions');
                        if (editingId && !editingId.startsWith('local_')) {
                            await ref.doc(editingId).update(data);
                        } else if (!editingId) {
                            await ref.add(data);
                        }
                    } catch (e) {
                        console.warn('Firebase sync failed, data saved locally:', e.message);
                    }
                }
            };

            const handleEdit = (t) => {
                setFormData({ articulo: t.articulo, monto: t.monto.toString(), fecha: t.fecha, seccion: t.seccion, subcategoria: t.subcategoria, cuotas: t.cuotas?.toString() || '', cuotaActual: t.cuotaActual?.toString() || '', diaVencimiento: t.diaVencimiento?.toString() || '' });
                setEditingId(t.id);
                setShowModal(true);
            };

            const handleDelete = async (id) => {
                // Eliminar de localStorage primero
                const newTransactions = transactions.filter(t => t.id !== id);
                setTransactions(newTransactions);
                saveToLocal(newTransactions);
                showToast('Movimiento eliminado');
                setDeleteConfirm(null);

                // Intentar eliminar de Firebase
                if (user && !id.startsWith('local_')) {
                    try {
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('transactions').doc(id).delete();
                    } catch (e) {
                        console.warn('Firebase delete failed:', e.message);
                    }
                }
            };

            const resetForm = () => {
                setFormData({ articulo: '', monto: '', fecha: today(), seccion: 'gastos_fijos', subcategoria: 'Renta', cuotas: '', cuotaActual: '', diaVencimiento: '' });
                setEditingId(null);
                setShowModal(false);
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 1 & 3: FILTRADO EN MEMORIA
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const filteredByTime = useMemo(() => {
                const now = new Date();
                return transactions.filter(t => {
                    const d = new Date(t.fecha);
                    if (timeFilter === 'dia') return d.toDateString() === now.toDateString();
                    if (timeFilter === 'semana') { const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000); return d >= weekAgo; }
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
            }, [transactions, timeFilter]);

            const byPilar = useMemo(() => ({
                gastos_fijos: filteredByTime.filter(t => t.seccion === 'gastos_fijos'),
                gastos_variables: filteredByTime.filter(t => t.seccion === 'gastos_variables'),
                tarjetas: filteredByTime.filter(t => t.seccion === 'tarjetas'),
                ahorro: filteredByTime.filter(t => t.seccion === 'ahorro'),
                inversiones: filteredByTime.filter(t => t.seccion === 'inversiones'),
                ingresos: filteredByTime.filter(t => t.seccion === 'ingresos')
            }), [filteredByTime]);

            const totals = useMemo(() => {
                const ingresos = byPilar.ingresos.reduce((s, t) => s + (t.monto || 0), 0);
                const gastosFijos = byPilar.gastos_fijos.reduce((s, t) => s + (t.monto || 0), 0);
                const gastosVar = byPilar.gastos_variables.reduce((s, t) => s + (t.monto || 0), 0);
                const tarjetas = byPilar.tarjetas.reduce((s, t) => s + (t.monto || 0), 0);
                const ahorro = byPilar.ahorro.reduce((s, t) => s + (t.monto || 0), 0);
                const inversiones = byPilar.inversiones.reduce((s, t) => s + (t.monto || 0), 0);
                const gastos = gastosFijos + gastosVar + tarjetas;
                const balance = ingresos - gastos;
                const patrimonio = ahorro + inversiones;
                return { ingresos, gastosFijos, gastosVar, tarjetas, gastos, ahorro, inversiones, balance, patrimonio };
            }, [byPilar]);

            // Alertas de vencimiento (5 d√≠as)
            const alertas = useMemo(() => {
                const hoy = new Date().getDate();
                return byPilar.tarjetas.filter(t => {
                    if (!t.diaVencimiento) return false;
                    const diff = t.diaVencimiento - hoy;
                    return diff >= 0 && diff <= 5;
                });
            }, [byPilar.tarjetas]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 4: DATOS PARA GR√ÅFICOS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const pieData = useMemo(() => [
                { name: 'Gastos Fijos', value: totals.gastosFijos, color: PILARES.gastos_fijos.color },
                { name: 'Gastos Variables', value: totals.gastosVar, color: PILARES.gastos_variables.color },
                { name: 'Tarjetas', value: totals.tarjetas, color: PILARES.tarjetas.color },
                { name: 'Ahorro', value: totals.ahorro, color: PILARES.ahorro.color },
                { name: 'Inversiones', value: totals.inversiones, color: PILARES.inversiones.color }
            ].filter(d => d.value > 0), [totals]);

            const trendData = useMemo(() => {
                const grouped = {};
                filteredByTime.forEach(t => {
                    const key = t.fecha;
                    if (!grouped[key]) grouped[key] = { fecha: key, ingresos: 0, gastos: 0 };
                    if (t.tipo === 'ingreso') grouped[key].ingresos += t.monto;
                    else if (t.tipo === 'gasto') grouped[key].gastos += t.monto;
                });
                return Object.values(grouped).sort((a, b) => a.fecha.localeCompare(b.fecha));
            }, [filteredByTime]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 4: INSIGHTS NLP
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const insights = useMemo(() => {
                const msgs = [];
                if (totals.ingresos > 0) {
                    const ratio = (totals.gastos / totals.ingresos) * 100;
                    if (ratio > 90) msgs.push({ type: 'danger', text: `‚ö†Ô∏è Atenci√≥n: Est√°s gastando el ${ratio.toFixed(0)}% de tus ingresos.` });
                    else if (ratio < 50) msgs.push({ type: 'success', text: `üéâ Excelente: Solo has utilizado el ${ratio.toFixed(0)}% de tus ingresos.` });
                }
                if (totals.patrimonio > 0) msgs.push({ type: 'info', text: `üíé Patrimonio acumulado: ${formatARS(totals.patrimonio)} en ahorro e inversiones.` });
                if (totals.gastosVar > totals.gastosFijos) msgs.push({ type: 'warning', text: `üìä Tus gastos variables superan a los fijos este per√≠odo.` });
                if (alertas.length > 0) msgs.push({ type: 'danger', text: `üîî Tienes ${alertas.length} vencimiento(s) de tarjeta pr√≥ximo(s).` });
                return msgs.slice(0, 3);
            }, [totals, alertas]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // RENDERS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="glass p-8 rounded-3xl max-w-md w-full text-center animate-fade">
                        <div className="text-rose-400 mb-4 flex justify-center"><Icons.Alert /></div>
                        <h2 className="text-xl font-bold mb-3">Configuraci√≥n Requerida</h2>
                        <p className="text-white/60 text-sm mb-6">{error}</p>
                        <button onClick={() => location.reload()} className="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-2xl font-bold transition-all">Reintentar</button>
                    </div>
                </div>
            );

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center gap-4">
                    <div className="text-indigo-400"><Icons.Loader /></div>
                    <p className="text-white/40 text-sm animate-pulse">Conectando con Firebase...</p>
                </div>
            );

            const renderList = (items, showCuotas = false) => (
                items.length === 0 ? (
                    <div className="text-center py-12 text-white/30">
                        <p className="text-4xl mb-3">üì≠</p>
                        <p className="text-sm">Sin movimientos registrados</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {items.sort((a, b) => b.fecha?.localeCompare(a.fecha)).map((t, i) => (
                            <div key={t.id} className="glass p-4 rounded-2xl flex justify-between items-center group hover:bg-white/10 transition-all cursor-pointer animate-stagger" style={{ animationDelay: `${i * 50}ms` }} onClick={() => handleEdit(t)}>
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style={{ background: `${PILARES[t.seccion]?.color}30` }}>{PILARES[t.seccion]?.icon}</div>
                                    <div>
                                        <p className="font-semibold text-sm">{t.articulo}</p>
                                        <p className="text-xs text-white/40">{t.subcategoria} ‚Ä¢ {t.fecha}</p>
                                        {showCuotas && t.cuotas && (
                                            <div className="mt-2 flex items-center gap-2">
                                                <div className="w-20 h-1.5 bg-white/10 rounded-full overflow-hidden">
                                                    <div className="h-full bg-purple-500 rounded-full" style={{ width: `${(t.cuotaActual / t.cuotas) * 100}%` }}></div>
                                                </div>
                                                <span className="text-[10px] text-white/50">{t.cuotaActual}/{t.cuotas}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className={`font-bold font-mono ${t.tipo === 'ingreso' ? 'text-emerald-400' : t.tipo === 'ahorro' || t.tipo === 'inversion' ? 'text-blue-400' : 'text-rose-400'}`}>
                                        {t.tipo === 'ingreso' ? '+' : '-'}{formatARS(t.monto)}
                                    </span>
                                    <button onClick={(e) => { e.stopPropagation(); setDeleteConfirm(t.id); }} className="opacity-0 group-hover:opacity-100 text-white/30 hover:text-rose-400 transition-all p-2"><Icons.Trash /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                )
            );

            return (
                <div className="min-h-screen pb-32 md:pb-8 md:pl-64">
                    {/* TOAST */}
                    {toast && (
                        <div className={`fixed top-6 right-6 z-50 glass px-6 py-4 rounded-2xl flex items-center gap-3 toast ${toast.type === 'error' ? 'border-rose-500/50 text-rose-300' : 'border-emerald-500/50 text-emerald-300'}`}>
                            {toast.type === 'error' ? <Icons.Alert /> : <Icons.Check />}
                            <span className="font-medium text-sm">{toast.msg}</span>
                        </div>
                    )}

                    {/* DELETE CONFIRM */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade" onClick={() => setDeleteConfirm(null)}>
                            <div className="glass p-8 rounded-3xl max-w-sm w-full text-center animate-pop" onClick={e => e.stopPropagation()}>
                                <p className="text-4xl mb-4">üóëÔ∏è</p>
                                <h3 className="text-lg font-bold mb-2">¬øEliminar movimiento?</h3>
                                <p className="text-white/50 text-sm mb-6">Esta acci√≥n no se puede deshacer.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConfirm(null)} className="flex-1 py-3 rounded-xl border border-white/20 hover:bg-white/10 font-semibold transition-all">Cancelar</button>
                                    <button onClick={() => handleDelete(deleteConfirm)} className="flex-1 py-3 rounded-xl bg-rose-600 hover:bg-rose-700 font-semibold transition-all">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SIDEBAR DESKTOP */}
                    <nav className="hidden md:flex fixed left-0 top-0 h-screen w-60 glass-dark flex-col p-6 z-40">
                        <h1 className="text-xl font-bold mb-2 flex items-center gap-2">üíµ Control ARS</h1>
                        <p className="text-[10px] text-white/40 uppercase tracking-widest mb-8">Versi√≥n Pro</p>
                        <div className="flex-1 space-y-2">
                            {TABS.map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-sm font-medium transition-all ${activeTab === tab.id ? 'bg-indigo-600 text-white' : 'text-white/60 hover:bg-white/10'}`}>
                                    <span>{tab.icon}</span> {tab.nombre}
                                </button>
                            ))}
                        </div>
                        <p className="text-[10px] text-white/30 text-center">UID: {user?.uid?.slice(0, 8)}</p>
                    </nav>

                    {/* HEADER MOBILE */}
                    <header className="md:hidden glass-dark p-5 sticky top-0 z-30">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-lg font-bold">üíµ Control ARS Pro</h1>
                                <p className="text-[10px] text-white/40">Balance: <span className={totals.balance >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{formatARS(totals.balance)}</span></p>
                            </div>
                        </div>
                    </header>

                    {/* CONTENIDO PRINCIPAL */}
                    <main className="max-w-4xl mx-auto p-4 md:p-8 space-y-6 animate-fade">
                        {/* ALERTAS DE VENCIMIENTO */}
                        {alertas.length > 0 && activeTab === 'dashboard' && (
                            <div className="glass border-amber-500/50 p-5 rounded-2xl flex items-start gap-4 animate-slide">
                                <div className="text-amber-400"><Icons.Alert /></div>
                                <div>
                                    <p className="font-bold text-sm text-amber-300">Vencimientos Pr√≥ximos</p>
                                    <p className="text-xs text-white/60 mt-1">{alertas.map(a => `${a.articulo} (d√≠a ${a.diaVencimiento})`).join(', ')}</p>
                                </div>
                            </div>
                        )}

                        {/* FILTROS TEMPORALES */}
                        <div className="flex gap-2">
                            {['dia', 'semana', 'mes'].map(f => (
                                <button key={f} onClick={() => setTimeFilter(f)} className={`px-4 py-2 rounded-xl text-xs font-semibold transition-all ${timeFilter === f ? 'bg-indigo-600' : 'glass hover:bg-white/10'}`}>
                                    {f === 'dia' ? 'Hoy' : f === 'semana' ? 'Semana' : 'Mes'}
                                </button>
                            ))}
                        </div>

                        {/* DASHBOARD */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Ingresos</p><p className="text-xl font-bold text-emerald-400">{formatARS(totals.ingresos)}</p></div>
                                    <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Gastos</p><p className="text-xl font-bold text-rose-400">{formatARS(totals.gastos)}</p></div>
                                    <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Balance</p><p className={`text-xl font-bold ${totals.balance >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatARS(totals.balance)}</p></div>
                                    <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Patrimonio</p><p className="text-xl font-bold text-blue-400">{formatARS(totals.patrimonio)}</p></div>
                                </div>

                                {/* INSIGHTS */}
                                {insights.length > 0 && (
                                    <div className="glass p-6 rounded-2xl space-y-3">
                                        <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider">Resumen Inteligente</h3>
                                        {insights.map((ins, i) => (
                                            <p key={i} className={`text-sm ${ins.type === 'danger' ? 'text-rose-300' : ins.type === 'success' ? 'text-emerald-300' : ins.type === 'warning' ? 'text-amber-300' : 'text-blue-300'}`}>{ins.text}</p>
                                        ))}
                                    </div>
                                )}

                                {/* DISTRIBUCI√ìN */}
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Distribuci√≥n</h3>
                                    <div className="space-y-4">
                                        {Object.entries(byPilar).map(([key, items]) => {
                                            const total = items.reduce((s, t) => s + (t.monto || 0), 0);
                                            const pct = totals.ingresos > 0 ? (total / totals.ingresos) * 100 : 0;
                                            return (
                                                <div key={key} className="group">
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="flex items-center gap-2"><span>{PILARES[key].icon}</span> {PILARES[key].nombre}</span>
                                                        <span className="font-mono">{formatARS(total)}</span>
                                                    </div>
                                                    <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                                        <div className="h-full rounded-full transition-all duration-700" style={{ width: `${Math.min(pct, 100)}%`, background: PILARES[key].color }}></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* √öLTIMOS MOVIMIENTOS */}
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">√öltimos Movimientos</h3>
                                    {renderList(filteredByTime.slice(0, 5))}
                                </div>
                            </div>
                        )}

                        {/* GASTOS */}
                        {activeTab === 'gastos' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Gastos Fijos</p><p className="text-xl font-bold text-rose-400">{formatARS(totals.gastosFijos)}</p></div>
                                    <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Gastos Variables</p><p className="text-xl font-bold text-orange-400">{formatARS(totals.gastosVar)}</p></div>
                                </div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Gastos Fijos</h3>
                                    {renderList(byPilar.gastos_fijos)}
                                </div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Gastos Variables</h3>
                                    {renderList(byPilar.gastos_variables)}
                                </div>
                            </div>
                        )}

                        {/* TARJETAS */}
                        {activeTab === 'tarjetas' && (
                            <div className="space-y-6">
                                <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Total Tarjetas</p><p className="text-xl font-bold text-purple-400">{formatARS(totals.tarjetas)}</p></div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Consumos</h3>
                                    {renderList(byPilar.tarjetas, true)}
                                </div>
                            </div>
                        )}

                        {/* AHORRO */}
                        {activeTab === 'ahorro' && (
                            <div className="space-y-6">
                                <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Total Ahorro</p><p className="text-xl font-bold text-blue-400">{formatARS(totals.ahorro)}</p></div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Movimientos de Ahorro</h3>
                                    {renderList(byPilar.ahorro)}
                                </div>
                            </div>
                        )}

                        {/* INVERSIONES */}
                        {activeTab === 'inversiones' && (
                            <div className="space-y-6">
                                <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Portafolio IOL</p><p className="text-xl font-bold text-cyan-400">{formatARS(totals.inversiones)}</p></div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Inversiones</h3>
                                    {renderList(byPilar.inversiones)}
                                </div>
                            </div>
                        )}

                        {/* INGRESOS */}
                        {activeTab === 'ingresos' && (
                            <div className="space-y-6">
                                <div className="glass p-5 rounded-2xl"><p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Total Ingresos</p><p className="text-xl font-bold text-emerald-400">{formatARS(totals.ingresos)}</p></div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Fuentes de Ingreso</h3>
                                    {renderList(byPilar.ingresos)}
                                </div>
                            </div>
                        )}

                        {/* AN√ÅLISIS */}
                        {activeTab === 'analisis' && (
                            <div className="space-y-6">
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Distribuci√≥n del Gasto</h3>
                                    {pieData.length > 0 ? (
                                        <ResponsiveContainer width="100%" height={280}>
                                            <PieChart>
                                                <Pie data={pieData} cx="50%" cy="50%" innerRadius={60} outerRadius={100} paddingAngle={3} dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`} labelLine={false}>
                                                    {pieData.map((entry, i) => <Cell key={i} fill={entry.color} />)}
                                                </Pie>
                                                <Tooltip formatter={(v) => formatARS(v)} contentStyle={{ background: 'rgba(15,23,42,0.9)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px' }} />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    ) : <p className="text-center text-white/30 py-12">Sin datos para mostrar</p>}
                                </div>
                                <div className="glass p-6 rounded-2xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Tendencia: Ingresos vs Gastos</h3>
                                    {trendData.length > 0 ? (
                                        <ResponsiveContainer width="100%" height={250}>
                                            <AreaChart data={trendData}>
                                                <defs>
                                                    <linearGradient id="colorIng" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.4} /><stop offset="95%" stopColor="#10b981" stopOpacity={0} /></linearGradient>
                                                    <linearGradient id="colorGas" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#f43f5e" stopOpacity={0.4} /><stop offset="95%" stopColor="#f43f5e" stopOpacity={0} /></linearGradient>
                                                </defs>
                                                <XAxis dataKey="fecha" tick={{ fill: 'rgba(255,255,255,0.4)', fontSize: 10 }} tickFormatter={v => v.slice(5)} />
                                                <YAxis tick={{ fill: 'rgba(255,255,255,0.4)', fontSize: 10 }} tickFormatter={v => `$${(v / 1000).toFixed(0)}k`} />
                                                <Tooltip formatter={(v) => formatARS(v)} contentStyle={{ background: 'rgba(15,23,42,0.9)', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '12px' }} />
                                                <Area type="monotone" dataKey="ingresos" stroke="#10b981" fill="url(#colorIng)" strokeWidth={2} />
                                                <Area type="monotone" dataKey="gastos" stroke="#f43f5e" fill="url(#colorGas)" strokeWidth={2} />
                                                <Legend wrapperStyle={{ paddingTop: '20px' }} />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    ) : <p className="text-center text-white/30 py-12">Sin datos para mostrar</p>}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* FAB */}
                    <button onClick={() => { resetForm(); setShowModal(true); }} className="fixed bottom-24 md:bottom-8 left-6 w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg shadow-indigo-500/30 flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-40">
                        <Icons.Plus />
                    </button>

                    {/* TAB BAR MOBILE */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 glass-dark p-2 flex justify-around z-40">
                        {TABS.slice(0, 5).map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${activeTab === tab.id ? 'text-white' : 'text-white/40'}`}>
                                <span className="text-lg">{tab.icon}</span>
                                <span className="text-[10px] font-medium">{tab.nombre}</span>
                            </button>
                        ))}
                    </nav>

                    {/* MODAL */}
                    {showModal && (
                        <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 bg-black/60 backdrop-blur-sm animate-fade" onClick={resetForm}>
                            <div className="glass w-full md:max-w-lg md:rounded-3xl rounded-t-3xl p-8 animate-slide max-h-[90vh] overflow-y-auto custom-scroll" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">{editingId ? '‚úèÔ∏è Editar' : '‚ûï Nuevo'} Movimiento</h2>
                                    <button onClick={resetForm} className="p-2 hover:bg-white/10 rounded-xl transition-all"><Icons.X /></button>
                                </div>
                                <form onSubmit={handleSave} className="space-y-5">
                                    <div>
                                        <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Art√≠culo / Concepto</label>
                                        <input type="text" required placeholder="Ej: Compra Supermercado" value={formData.articulo} onChange={e => setFormData({ ...formData, articulo: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Monto (ARS)</label>
                                            <input type="number" required inputMode="decimal" placeholder="0" value={formData.monto} onChange={e => setFormData({ ...formData, monto: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all font-mono" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Fecha</label>
                                            <input type="date" required value={formData.fecha} onChange={e => setFormData({ ...formData, fecha: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Pilar</label>
                                        <select value={formData.seccion} onChange={e => setFormData({ ...formData, seccion: e.target.value, subcategoria: PILARES[e.target.value].subcategorias[0] })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none appearance-none cursor-pointer focus:border-indigo-500 transition-all">
                                            {Object.entries(PILARES).map(([key, val]) => <option key={key} value={key} className="bg-slate-900">{val.icon} {val.nombre}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Subcategor√≠a</label>
                                        <select value={formData.subcategoria} onChange={e => setFormData({ ...formData, subcategoria: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none appearance-none cursor-pointer focus:border-indigo-500 transition-all">
                                            {PILARES[formData.seccion].subcategorias.map(s => <option key={s} value={s} className="bg-slate-900">{s}</option>)}
                                        </select>
                                    </div>

                                    {/* CAMPOS CONDICIONALES TARJETAS */}
                                    {formData.seccion === 'tarjetas' && (
                                        <div className="glass p-4 rounded-xl space-y-4">
                                            <p className="text-xs text-white/60 flex items-center gap-2">üí≥ Configuraci√≥n de Cuotas</p>
                                            <div className="grid grid-cols-3 gap-3">
                                                <div>
                                                    <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Total Cuotas</label>
                                                    <input type="number" inputMode="numeric" placeholder="12" value={formData.cuotas} onChange={e => setFormData({ ...formData, cuotas: e.target.value })} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:border-purple-500 transition-all text-center" />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Cuota Actual</label>
                                                    <input type="number" inputMode="numeric" placeholder="1" value={formData.cuotaActual} onChange={e => setFormData({ ...formData, cuotaActual: e.target.value })} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:border-purple-500 transition-all text-center" />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">D√≠a Venc.</label>
                                                    <input type="number" inputMode="numeric" placeholder="10" value={formData.diaVencimiento} onChange={e => setFormData({ ...formData, diaVencimiento: e.target.value })} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:border-purple-500 transition-all text-center" />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <button type="submit" className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-[0.98]">
                                        {editingId ? 'Actualizar' : 'Guardar'} Movimiento
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>