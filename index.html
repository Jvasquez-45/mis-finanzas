<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Control Financiero ARS Pro</title>

    <!-- React 18 Core -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- React Dependencies for Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts (after React dependencies) -->
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', system-ui, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
            min-height: 100vh;
        }

        .glass {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-dark {
            backdrop-filter: blur(20px);
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .blob1 {
            position: fixed;
            top: -20%;
            left: -10%;
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .blob2 {
            position: fixed;
            bottom: -30%;
            right: -15%;
            width: 700px;
            height: 700px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .blob3 {
            position: fixed;
            top: 40%;
            right: 20%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(34, 211, 238, 0.15) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes stagger {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .animate-fade {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .animate-slide {
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .animate-pop {
            animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .animate-stagger {
            animation: stagger 0.3s ease-out forwards;
        }

        .custom-scroll::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .toast {
            animation: slideUp 0.3s ease-out, fadeIn 0.3s ease-out reverse forwards 2.5s;
        }

        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }
    </style>
</head>

<body class="text-white overflow-x-hidden">
    <div class="blob1"></div>
    <div class="blob2"></div>
    <div class="blob3"></div>
    <div id="root" class="relative z-10"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;
        const { PieChart, Pie, Cell, AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend } = Recharts;

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // FASE 1: CONFIGURACI√ìN Y MODELO DE DATOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const firebaseConfig = {
            apiKey: "AIzaSyCiJwLv-jw1EQT3FNT6gdWw2NV51UxvbQU",
            authDomain: "finanzas-44f11.firebaseapp.com",
            projectId: "finanzas-44f11",
            storageBucket: "finanzas-44f11.firebasestorage.app",
            messagingSenderId: "403874855146",
            appId: "1:403874855146:web:1f0bc48e339e06316cff93"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'finanzas-44f11-app';

        // CONSTANTES DE MODELO DE DATOS
        const PILARES = {
            gastos: { nombre: 'Gasto', tipo: 'gasto', color: '#f43f5e', icon: 'üí∏', subcategorias: ['Alquiler', 'Luz', 'Agua', 'Gas', 'Internet', 'Servicio de Streaming', 'Personal', 'Ocio', 'Limpieza e Higiene', 'Movilidad', 'Otros'] },
            ahorro: { nombre: 'Ahorro', tipo: 'ahorro', color: '#3b82f6', icon: 'üè¶', subcategorias: ['Ahorro en pesos', 'Ahorro personal'] },
            inversiones: { nombre: 'Inversi√≥n', tipo: 'inversion', color: '#06b6d4', icon: 'üìà', subcategorias: ['IOL Letras', 'IOL Acciones', 'IOL CEDEARS', 'Fondo Com√∫n de Inversiones (FCI)'] },
            ingresos: { nombre: 'Ingreso', tipo: 'ingreso', color: '#10b981', icon: 'üí∞', subcategorias: ['Sueldo', 'Marketing', 'Moto (Uber/Didi)', 'Ventas', 'Otros'] }
        };

        const MEDIOS_PAGO = [
            { id: 'efectivo', nombre: 'Efectivo/D√©bito', icon: 'üíµ' },
            { id: 'visa', nombre: 'Visa', icon: 'üí≥' },
            { id: 'mastercard', nombre: 'Mastercard', icon: 'üí≥' },
            { id: 'amex', nombre: 'Amex', icon: 'üí≥' },
            { id: 'otro_tarjeta', nombre: 'Otra Tarjeta', icon: 'üí≥' }
        ];

        const TABS = [
            { id: 'dashboard', nombre: 'Resumen', icon: 'üìä' },
            { id: 'gastos', nombre: 'Gastos', icon: 'üí∏' },
            { id: 'tarjetas', nombre: 'Tarjetas', icon: 'üí≥' },
            { id: 'ahorro', nombre: 'Ahorro', icon: 'üè¶' },
            { id: 'inversiones', nombre: 'Inversiones', icon: 'üìà' },
            { id: 'ingresos', nombre: 'Ingresos', icon: 'üí∞' },
            { id: 'analisis', nombre: 'An√°lisis', icon: 'üìâ' }
        ];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ICONOS SVG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const Icons = {
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M12 5v14M5 12h14" /></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 6L6 18M6 6l12 12" /></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2" /></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" /></svg>,
            Alert: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4M12 17h.01" /></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M20 6L9 17l-5-5" /></svg>,
            Loader: () => <svg className="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12a9 9 0 11-6.219-8.56" /></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z" /></svg>,
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg>,
            ChevronDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M6 9l6 6 6-6" /></svg>,
            Tarjeta: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg>,
            Trend: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18" /><polyline points="17 6 23 6 23 12" /></svg>
        };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // UTILIDADES
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const formatARS = (v) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(v || 0);
        const today = () => new Date().toISOString().split('T')[0];

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // COMPONENTE PRINCIPAL
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [activeTab, setActiveTab] = useState(() => localStorage.getItem('activeTab') || 'dashboard');
            const [showModal, setShowModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [toast, setToast] = useState(null);
            const [deleteConfirm, setDeleteConfirm] = useState(null);
            const [timeFilter, setTimeFilter] = useState('mes');

            const [formData, setFormData] = useState({
                articulo: '', tienda: '', monto: '', fecha: today(), seccion: 'gastos', subcategoria: 'Alquiler',
                metodoPago: 'efectivo', cuotas: '1', cuotaActual: '1', diaVencimiento: '10'
            });

            const [showFilterMenu, setShowFilterMenu] = useState(false);
            const [compareMode, setCompareMode] = useState('standard'); // 'standard', 'compare_mes', 'compare_dia'
            const [periodA, setPeriodA] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM
            const [periodB, setPeriodB] = useState(() => {
                const d = new Date(); d.setMonth(d.getMonth() - 1);
                return d.toISOString().slice(0, 7);
            });
            const [sessionStartAmount, setSessionStartAmount] = useState(0);
            const [isEditingStartAmount, setIsEditingStartAmount] = useState(false);
            const [tempStartAmount, setTempStartAmount] = useState('0');

            // Persistir pesta√±a activa
            useEffect(() => { localStorage.setItem('activeTab', activeTab); }, [activeTab]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // SISTEMA DE ALMACENAMIENTO LOCAL (100% localStorage)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const STORAGE_KEY = 'finanzas_ars_pro_data';

            // Cargar datos de localStorage al iniciar
            useEffect(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        console.log('Datos cargados de localStorage:', parsed.length, 'registros');
                        setTransactions(parsed);
                    }
                } catch (e) {
                    console.error('Error loading from localStorage:', e);
                }
                setLoading(false);
            }, []);

            // Guardar en localStorage cada vez que cambian las transacciones
            // Solo si no estamos cargando inicialmente para evitar sobreescritura accidental
            useEffect(() => {
                if (loading) return;

                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                    console.log('Datos guardados en localStorage:', transactions.length, 'registros');
                } catch (e) {
                    console.error('Error saving to localStorage:', e);
                }
            }, [transactions, loading]);

            // Auth (solo para mostrar UID, no afecta almacenamiento)
            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async (u) => {
                    if (!u) {
                        try { await auth.signInAnonymously(); }
                        catch (e) { console.warn('Firebase auth unavailable'); }
                    } else { setUser(u); }
                });
                return () => unsub();
            }, []);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 3: L√ìGICA CRUD (100% local)
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const showToast = (msg, type = 'success') => { setToast({ msg, type }); setTimeout(() => setToast(null), 3000); };

            // Generar ID √∫nico local
            const generateId = () => 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            const handleSave = (e) => {
                e.preventDefault();
                if (!formData.articulo || !formData.monto) return;

                const data = {
                    articulo: formData.articulo,
                    tienda: formData.tienda,
                    monto: parseFloat(formData.monto),
                    fecha: formData.fecha,
                    seccion: formData.seccion,
                    subcategoria: formData.subcategoria,
                    metodoPago: formData.metodoPago,
                    tipo: PILARES[formData.seccion].tipo,
                    timestamp: new Date().toISOString(),
                    ...(formData.metodoPago !== 'efectivo' && { cuotas: parseInt(formData.cuotas) || 1, cuotaActual: parseInt(formData.cuotaActual) || 1, diaVencimiento: parseInt(formData.diaVencimiento) || 10 })
                };

                if (editingId) {
                    // Actualizar existente
                    setTransactions(prev => prev.map(t => t.id === editingId ? { ...data, id: editingId } : t));
                    showToast('Movimiento actualizado');
                } else {
                    // Crear nuevo
                    const newId = generateId();
                    setTransactions(prev => [...prev, { ...data, id: newId }]);
                    showToast('Movimiento guardado');
                }
                resetForm();
            };

            const handleEdit = (t) => {
                setFormData({
                    articulo: t.articulo,
                    tienda: t.tienda || '',
                    monto: t.monto.toString(),
                    fecha: t.fecha,
                    seccion: t.seccion || 'gastos',
                    subcategoria: t.subcategoria,
                    metodoPago: t.metodoPago || (t.seccion === 'tarjetas' ? 'visa' : 'efectivo'),
                    cuotas: t.cuotas?.toString() || '1',
                    cuotaActual: t.cuotaActual?.toString() || '1',
                    diaVencimiento: t.diaVencimiento?.toString() || '10'
                });
                setEditingId(t.id);
                setShowModal(true);
            };

            const handleDelete = (id) => {
                setTransactions(prev => prev.filter(t => t.id !== id));
                showToast('Movimiento eliminado');
                setDeleteConfirm(null);
            };

            const resetForm = () => {
                setFormData({ articulo: '', tienda: '', monto: '', fecha: today(), seccion: 'gastos', subcategoria: 'Alquiler', metodoPago: 'efectivo', cuotas: '1', cuotaActual: '1', diaVencimiento: '10' });
                setEditingId(null);
                setShowModal(false);
            };

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 1 & 3: FILTRADO EN MEMORIA Y COMPARATIVAS AVANZADAS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const comparisonData = useMemo(() => {
                let rangeA = { start: new Date(), end: new Date() };
                let rangeB = { start: new Date(), end: new Date() };

                const now = new Date();
                if (timeFilter === 'mes') {
                    rangeA.start = new Date(now.getFullYear(), now.getMonth(), 1);
                    rangeB.start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    rangeB.end = new Date(now.getFullYear(), now.getMonth(), 0, 23, 59, 59);
                } else if (timeFilter === 'semana') {
                    rangeA.start = new Date(new Date().setDate(now.getDate() - 7));
                    rangeB.start = new Date(new Date().setDate(now.getDate() - 14));
                    rangeB.end = new Date(new Date().setDate(now.getDate() - 8));
                    rangeB.end.setHours(23, 59, 59);
                } else if (timeFilter === 'dia') {
                    rangeA.start.setHours(0, 0, 0, 0);
                    rangeB.start.setDate(now.getDate() - 1); rangeB.start.setHours(0, 0, 0, 0);
                    rangeB.end.setDate(now.getDate() - 1); rangeB.end.setHours(23, 59, 59);
                } else if (timeFilter === 'compare_mes') {
                    rangeA.start = new Date(periodA + "-01T00:00:00");
                    rangeB.start = new Date(periodB + "-01T00:00:00");
                    rangeA.end = new Date(rangeA.start.getFullYear(), rangeA.start.getMonth() + 1, 0, 23, 59, 59);
                    rangeB.end = new Date(rangeB.start.getFullYear(), rangeB.start.getMonth() + 1, 0, 23, 59, 59);
                } else if (timeFilter === 'compare_dia') {
                    rangeA.start = new Date(periodA + "T00:00:00");
                    rangeB.start = new Date(periodB + "T00:00:00");
                    rangeA.end = new Date(periodA + "T23:59:59");
                    rangeB.end = new Date(periodB + "T23:59:59");
                }

                const dataA = transactions.filter(t => { const d = new Date(t.fecha); return d >= rangeA.start && d <= (rangeA.end > now && !timeFilter.includes('compare') ? now : rangeA.end || now); });
                const dataB = transactions.filter(t => { const d = new Date(t.fecha); return d >= rangeB.start && d <= rangeB.end; });

                const sum = (arr) => arr.reduce((s, t) => s + (t.monto || 0), 0);
                const filterGastos = (arr) => arr.filter(t => t.tipo === 'gasto' || t.seccion === 'tarjetas');

                const curGastos = sum(filterGastos(dataA));
                const prevGastos = sum(filterGastos(dataB));

                const calcPct = (c, p) => p === 0 ? (c > 0 ? 100 : 0) : ((c - p) / p) * 100;

                return {
                    gastosPct: calcPct(curGastos, prevGastos),
                    curGastos,
                    prevGastos,
                    filtered: dataA,
                    labelA: timeFilter.includes('compare') ? (timeFilter === 'compare_mes' ? periodA : periodA) : 'Actual',
                    labelB: timeFilter.includes('compare') ? (timeFilter === 'compare_mes' ? periodB : periodB) : 'Anterior'
                };
            }, [transactions, timeFilter, periodA, periodB]);

            const filteredByTime = comparisonData.filtered;

            const byPilar = useMemo(() => {
                const groups = { gastos: [], ahorro: [], inversiones: [], ingresos: [], tarjetas: [] };
                filteredByTime.forEach(t => {
                    // Mapeo de compatibilidad para datos viejos
                    let sec = t.seccion;
                    if (sec === 'gastos_fijos' || sec === 'gastos_variables') sec = 'gastos';

                    if (groups[sec]) groups[sec].push(t);
                    else if (sec === 'tarjetas') groups.tarjetas.push(t); // Retrocompatibilidad

                    if (t.metodoPago && t.metodoPago !== 'efectivo') {
                        if (!groups.tarjetas.includes(t)) groups.tarjetas.push(t);
                    }
                });
                return groups;
            }, [filteredByTime]);

            const totals = useMemo(() => {
                const ingresos = byPilar.ingresos.reduce((s, t) => s + (t.monto || 0), 0);
                const gastos = byPilar.gastos.reduce((s, t) => s + (t.monto || 0), 0);
                const ahorro = byPilar.ahorro.reduce((s, t) => s + (t.monto || 0), 0);
                const inversiones = byPilar.inversiones.reduce((s, t) => s + (t.monto || 0), 0);
                const tarjetas = (byPilar.tarjetas || []).reduce((s, t) => s + (t.monto || 0), 0);
                const balance = ingresos - gastos;
                const patrimonio = ahorro + inversiones;
                return { ingresos, gastos, tarjetas, ahorro, inversiones, balance, patrimonio };
            }, [byPilar]);

            // Alertas de vencimiento (5 d√≠as)
            const alertas = useMemo(() => {
                const hoy = new Date().getDate();
                return byPilar.tarjetas.filter(t => {
                    if (!t.diaVencimiento) return false;
                    const diff = t.diaVencimiento - hoy;
                    return diff >= 0 && diff <= 5;
                });
            }, [byPilar.tarjetas]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 4: DATOS PARA GR√ÅFICOS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const pieData = useMemo(() => [
                { name: 'Gastos', value: totals.gastos, color: PILARES.gastos.color },
                { name: 'Ahorro', value: totals.ahorro, color: PILARES.ahorro.color },
                { name: 'Inversiones', value: totals.inversiones, color: PILARES.inversiones.color }
            ].filter(d => d.value > 0), [totals]);

            const trendData = useMemo(() => {
                const grouped = {};
                filteredByTime.forEach(t => {
                    const key = t.fecha;
                    if (!grouped[key]) grouped[key] = { fecha: key, ingresos: 0, gastos: 0 };
                    if (t.tipo === 'ingreso') grouped[key].ingresos += t.monto;
                    else if (t.tipo === 'gasto') grouped[key].gastos += t.monto;
                });
                return Object.values(grouped).sort((a, b) => a.fecha.localeCompare(b.fecha));
            }, [filteredByTime]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // FASE 4: INSIGHTS NLP
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            const insights = useMemo(() => {
                const msgs = [];
                if (totals.ingresos > 0) {
                    const ratio = (totals.gastos / totals.ingresos) * 100;
                    if (ratio > 90) msgs.push({ type: 'danger', text: `‚ö†Ô∏è Atenci√≥n: Est√°s gastando el ${ratio.toFixed(0)}% de tus ingresos.` });
                    else if (ratio < 50) msgs.push({ type: 'success', text: `üéâ Excelente: Solo has utilizado el ${ratio.toFixed(0)}% de tus ingresos.` });
                }
                if (totals.patrimonio > 0) msgs.push({ type: 'info', text: `üíé Patrimonio acumulado: ${formatARS(totals.patrimonio)} en ahorro e inversiones.` });
                if (alertas.length > 0) msgs.push({ type: 'danger', text: `üîî Tienes ${alertas.length} vencimiento(s) de tarjeta pr√≥ximo(s).` });
                return msgs.slice(0, 3);
            }, [totals, alertas]);

            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            // RENDERS
            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-6">
                    <div className="glass p-8 rounded-3xl max-w-md w-full text-center animate-fade">
                        <div className="text-rose-400 mb-4 flex justify-center"><Icons.Alert /></div>
                        <h2 className="text-xl font-bold mb-3">Configuraci√≥n Requerida</h2>
                        <p className="text-white/60 text-sm mb-6">{error}</p>
                        <button onClick={() => location.reload()} className="w-full bg-indigo-600 hover:bg-indigo-700 py-4 rounded-2xl font-bold transition-all">Reintentar</button>
                    </div>
                </div>
            );

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center gap-4">
                    <div className="text-indigo-400"><Icons.Loader /></div>
                    <p className="text-white/40 text-sm animate-pulse">Conectando con Firebase...</p>
                </div>
            );

            const renderList = (items, showCuotas = false) => (
                items.length === 0 ? (
                    <div className="text-center py-12 text-white/30">
                        <p className="text-4xl mb-3">üì≠</p>
                        <p className="text-sm">Sin movimientos registrados</p>
                    </div>
                ) : (
                    <div className="space-y-3">
                        {items.sort((a, b) => b.fecha?.localeCompare(a.fecha)).map((t, i) => (
                            <div key={t.id} className="glass p-4 rounded-2xl flex justify-between items-center group hover:bg-white/10 transition-all cursor-pointer animate-stagger" style={{ animationDelay: `${i * 50}ms` }} onClick={() => handleEdit(t)}>
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-xl flex items-center justify-center text-lg" style={{ background: `${(PILARES[t.seccion] || PILARES[t.seccion === 'gastos_fijos' || t.seccion === 'gastos_variables' ? 'gastos' : 'gastos'])?.color || '#6366f1'}30` }}>
                                        {t.metodoPago && t.metodoPago !== 'efectivo' ? 'üí≥' : (PILARES[t.seccion]?.icon || (t.seccion === 'gastos_fijos' || t.seccion === 'gastos_variables' ? 'üí∏' : 'üìù'))}
                                    </div>
                                    <div>
                                        <p className="font-semibold text-sm">{t.articulo}</p>
                                        <p className="text-xs text-white/40">
                                            {t.tienda ? `${t.tienda} ‚Ä¢ ` : ''}
                                            {t.metodoPago && t.metodoPago !== 'efectivo' ? `${MEDIOS_PAGO.find(m => m.id === t.metodoPago)?.nombre} ‚Ä¢ ` : ''}
                                            {t.subcategoria} ‚Ä¢ {t.fecha}
                                        </p>
                                        {showCuotas && t.cuotas && (
                                            <div className="mt-2 flex items-center gap-2">
                                                <div className="w-20 h-1.5 bg-white/10 rounded-full overflow-hidden">
                                                    <div className="h-full bg-purple-500 rounded-full" style={{ width: `${(t.cuotaActual / t.cuotas) * 100}%` }}></div>
                                                </div>
                                                <span className="text-[10px] text-white/50">{t.cuotaActual}/{t.cuotas}</span>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <span className={`font-bold font-mono ${t.tipo === 'ingreso' ? 'text-emerald-400' : t.tipo === 'ahorro' || t.tipo === 'inversion' ? 'text-blue-400' : 'text-rose-400'}`}>
                                        {t.tipo === 'ingreso' ? '+' : '-'}{formatARS(t.monto)}
                                    </span>
                                    <button onClick={(e) => { e.stopPropagation(); setDeleteConfirm(t.id); }} className="opacity-0 group-hover:opacity-100 text-white/30 hover:text-rose-400 transition-all p-2"><Icons.Trash /></button>
                                </div>
                            </div>
                        ))}
                    </div>
                )
            );

            return (
                <div className="min-h-screen pb-32 md:pb-8 md:pl-64">
                    {/* TOAST */}
                    {toast && (
                        <div className={`fixed top-6 right-6 z-50 glass px-6 py-4 rounded-2xl flex items-center gap-3 toast ${toast.type === 'error' ? 'border-rose-500/50 text-rose-300' : 'border-emerald-500/50 text-emerald-300'}`}>
                            {toast.type === 'error' ? <Icons.Alert /> : <Icons.Check />}
                            <span className="font-medium text-sm">{toast.msg}</span>
                        </div>
                    )}

                    {/* DELETE CONFIRM */}
                    {deleteConfirm && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade" onClick={() => setDeleteConfirm(null)}>
                            <div className="glass p-8 rounded-3xl max-w-sm w-full text-center animate-pop" onClick={e => e.stopPropagation()}>
                                <p className="text-4xl mb-4">üóëÔ∏è</p>
                                <h3 className="text-lg font-bold mb-2">¬øEliminar movimiento?</h3>
                                <p className="text-white/50 text-sm mb-6">Esta acci√≥n no se puede deshacer.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConfirm(null)} className="flex-1 py-3 rounded-xl border border-white/20 hover:bg-white/10 font-semibold transition-all">Cancelar</button>
                                    <button onClick={() => handleDelete(deleteConfirm)} className="flex-1 py-3 rounded-xl bg-rose-600 hover:bg-rose-700 font-semibold transition-all">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SIDEBAR DESKTOP */}
                    <nav className="hidden md:flex fixed left-0 top-0 h-screen w-60 glass-dark flex-col p-6 z-40">
                        <h1 className="text-xl font-bold mb-2 flex items-center gap-2">üíµ Control ARS</h1>
                        <p className="text-[10px] text-white/40 uppercase tracking-widest mb-8">Versi√≥n Pro</p>
                        <div className="flex-1 space-y-2">
                            {TABS.map(tab => (
                                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left text-sm font-medium transition-all ${activeTab === tab.id ? 'bg-indigo-600 text-white' : 'text-white/60 hover:bg-white/10'}`}>
                                    <span>{tab.icon}</span> {tab.nombre}
                                </button>
                            ))}
                        </div>
                        <p className="text-[10px] text-white/30 text-center">UID: {user?.uid?.slice(0, 8)}</p>
                    </nav>

                    {/* HEADER MOBILE */}
                    <header className="md:hidden glass-dark p-5 sticky top-0 z-30">
                        <div className="flex justify-between items-center">
                            <div>
                                <h1 className="text-lg font-bold">üíµ Control ARS Pro</h1>
                                <p className="text-[10px] text-white/40">Balance: <span className={totals.balance >= 0 ? 'text-emerald-400' : 'text-rose-400'}>{formatARS(totals.balance)}</span></p>
                            </div>
                        </div>
                    </header>

                    {/* CONTENIDO PRINCIPAL */}
                    <main className="max-w-4xl mx-auto p-4 md:p-8 space-y-6 animate-fade">
                        {/* ALERTAS DE VENCIMIENTO */}
                        {alertas.length > 0 && activeTab === 'dashboard' && (
                            <div className="glass border-amber-500/50 p-5 rounded-2xl flex items-start gap-4 animate-slide">
                                <div className="text-amber-400"><Icons.Alert /></div>
                                <div>
                                    <p className="font-bold text-sm text-amber-300">Vencimientos Pr√≥ximos</p>
                                    <p className="text-xs text-white/60 mt-1">{alertas.map(a => `${a.articulo} (d√≠a ${a.diaVencimiento})`).join(', ')}</p>
                                </div>
                            </div>
                        )}

                        {/* FILTRO PREMIUM REDISE√ëADO */}
                        <div className="relative group/filter">
                            <button onClick={() => setShowFilterMenu(!showFilterMenu)} className="bg-[#1a1c2e] px-5 py-3 rounded-2xl text-xs font-extrabold flex items-center gap-3 hover:bg-[#252845] transition-all border border-white/10 shadow-[0_8px_30px_rgb(0,0,0,0.5)] active:scale-95">
                                <span className="text-indigo-400 scale-110"><Icons.Filter /></span>
                                <span className="text-white tracking-wide">
                                    {timeFilter === 'compare_mes' ? `Comparar Meses` : timeFilter === 'compare_dia' ? `Comparar D√≠as` : `Ver: ${timeFilter === 'dia' ? 'Hoy' : timeFilter === 'semana' ? 'Esta Semana' : 'Este Mes'}`}
                                </span>
                                <span className="text-white/40 transition-transform duration-500" style={{ transform: showFilterMenu ? 'rotate(180deg)' : 'rotate(0deg)' }}><Icons.ChevronDown /></span>
                            </button>

                            {showFilterMenu && (
                                <>
                                    <div className="fixed inset-0 z-[100]" onClick={() => setShowFilterMenu(false)}></div>
                                    <div className="absolute top-14 left-0 w-80 bg-[#121421] border border-white/10 rounded-3xl p-3 shadow-[0_20px_50px_rgba(0,0,0,0.8)] z-[101] animate-pop origin-top-left ring-1 ring-white/5 backdrop-blur-xl">
                                        <div className="px-4 py-4 border-b border-white/5 mb-2">
                                            <p className="text-[10px] uppercase text-indigo-400 font-black tracking-[0.2em]">Configurar Dashboard</p>
                                        </div>

                                        <div className="space-y-1">
                                            <p className="px-4 py-2 text-[9px] uppercase text-white/20 font-bold tracking-widest">Filtros R√°pidos</p>
                                            {[
                                                { id: 'dia', label: 'Hoy vs Ayer', desc: 'Vista diaria r√°pida', icon: '‚òÄÔ∏è' },
                                                { id: 'semana', label: 'Semana vs Pasada', desc: 'Ciclo de 7 d√≠as', icon: 'üìÜ' },
                                                { id: 'mes', label: 'Mes Actual vs Anterior', desc: 'Resumen mensual', icon: 'üìÖ' }
                                            ].map(opt => (
                                                <button key={opt.id} onClick={() => { setTimeFilter(opt.id); setShowFilterMenu(false); }} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl text-left transition-all ${timeFilter === opt.id ? 'bg-indigo-600/20 ring-1 ring-indigo-500/50' : 'hover:bg-white/5'}`}>
                                                    <span className="text-xl">{opt.icon}</span>
                                                    <div>
                                                        <p className={`text-xs font-bold ${timeFilter === opt.id ? 'text-white' : 'text-white/60'}`}>{opt.label}</p>
                                                        <p className="text-[9px] text-white/30 font-medium">{opt.desc}</p>
                                                    </div>
                                                </button>
                                            ))}

                                            <p className="px-4 py-2 mt-4 text-[9px] uppercase text-white/20 font-bold tracking-widest">Comparativa Personalizada</p>

                                            {/* MODO COMPARAR MESES */}
                                            <div className={`p-4 rounded-2xl transition-all ${timeFilter === 'compare_mes' ? 'bg-purple-600/10 ring-1 ring-purple-500/30' : 'hover:bg-white/5'}`}>
                                                <button onClick={() => setTimeFilter('compare_mes')} className="flex items-center gap-4 w-full text-left mb-3">
                                                    <span className="text-xl">üìä</span>
                                                    <p className="text-xs font-bold text-white/60">Comparar dos Meses</p>
                                                </button>
                                                {timeFilter === 'compare_mes' && (
                                                    <div className="grid grid-cols-2 gap-2 animate-fade">
                                                        <input type="month" value={periodA} onChange={e => setPeriodA(e.target.value)} className="bg-white/5 border border-white/10 p-2 rounded-lg text-[10px] text-white focus:border-indigo-500 outline-none" />
                                                        <input type="month" value={periodB} onChange={e => setPeriodB(e.target.value)} className="bg-white/5 border border-white/10 p-2 rounded-lg text-[10px] text-white focus:border-indigo-500 outline-none" />
                                                    </div>
                                                )}
                                            </div>

                                            {/* MODO COMPARAR D√çAS */}
                                            <div className={`p-4 rounded-2xl transition-all ${timeFilter === 'compare_dia' ? 'bg-amber-600/10 ring-1 ring-amber-500/30' : 'hover:bg-white/5'}`}>
                                                <button onClick={() => setTimeFilter('compare_dia')} className="flex items-center gap-4 w-full text-left mb-3">
                                                    <span className="text-xl">‚öñÔ∏è</span>
                                                    <p className="text-xs font-bold text-white/60">Comparar dos D√≠as</p>
                                                </button>
                                                {timeFilter === 'compare_dia' && (
                                                    <div className="grid grid-cols-2 gap-2 animate-fade">
                                                        <input type="date" value={periodA} onChange={e => setPeriodA(e.target.value)} className="bg-white/5 border border-white/10 p-2 rounded-lg text-[10px] text-white focus:border-indigo-500 outline-none" />
                                                        <input type="date" value={periodB} onChange={e => setPeriodB(e.target.value)} className="bg-white/5 border border-white/10 p-2 rounded-lg text-[10px] text-white focus:border-indigo-500 outline-none" />
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        {/* DASHBOARD PREMIUM */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade">
                                {/* HERO SECTION: BALANCE TOTAL */}
                                <div className="glass p-8 rounded-[2.5rem] border border-white/10 relative overflow-hidden group">
                                    <div className="absolute top-0 right-0 p-12 opacity-5 scale-150 rotate-12">
                                        <div className="text-indigo-500 w-32 h-32"><Icons.Trend /></div>
                                    </div>
                                    <div className="relative z-10 flex flex-col md:flex-row md:items-center justify-between gap-8">
                                        <div>
                                            <p className="text-[10px] uppercase text-indigo-400 font-extrabold tracking-[0.2em] mb-3">Dinero Total Disponible</p>
                                            <h2 className="text-5xl font-black text-white tracking-tighter mb-2">
                                                {formatARS(sessionStartAmount + totals.balance)}
                                            </h2>
                                            <div className="flex items-center gap-3">
                                                <span className="text-[10px] text-white/40 font-bold uppercase tracking-widest">Rendimiento sesi√≥n</span>
                                                <span className={`px-2 py-0.5 rounded-lg text-[10px] font-black ${totals.balance >= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                                    {totals.balance >= 0 ? '‚Üó' : '‚Üò'} {formatARS(Math.abs(totals.balance))}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex flex-col gap-4 min-w-[240px]">
                                            <button
                                                onClick={() => { setTempStartAmount(sessionStartAmount.toString()); setIsEditingStartAmount(true); }}
                                                className="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-2xl border border-indigo-400/30 flex items-center justify-center gap-3 transition-all active:scale-95 shadow-[0_10px_30px_rgba(79,70,229,0.3)] group/btn"
                                            >
                                                <span className="scale-110 group-hover/btn:rotate-12 transition-transform"><Icons.Plus /></span>
                                                <span className="text-sm">Configurar Saldo Total</span>
                                            </button>

                                            <div className="bg-white/5 p-4 rounded-2xl border border-white/5">
                                                <p className="text-[9px] uppercase text-white/30 font-bold mb-1">Monto Base (Sesi√≥n)</p>
                                                <span className="text-xl font-black text-white">{formatARS(sessionStartAmount)}</span>
                                            </div>

                                            <div className="space-y-2">
                                                <div className="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                                                    <div
                                                        className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 rounded-full transition-all duration-1000"
                                                        style={{ width: `${Math.min(100, Math.max(0, sessionStartAmount === 0 ? (totals.balance > 0 ? 100 : 0) : ((sessionStartAmount + totals.balance) / sessionStartAmount) * 50))}%` }}
                                                    ></div>
                                                </div>
                                                <div className="flex justify-between text-[9px] font-bold uppercase tracking-tighter text-white/20">
                                                    <span>Progreso: {sessionStartAmount === 0 ? 'N/A' : `${((totals.balance / sessionStartAmount) * 100).toFixed(1)}%`}</span>
                                                    <span>Sesi√≥n Live</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* GRID SUPERIOR (BENTO) */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div className="md:col-span-2 glass p-6 rounded-3xl relative overflow-hidden group">
                                        <div className="absolute top-0 right-0 p-8 opacity-10 group-hover:scale-110 transition-transform duration-700">
                                            <div className="w-32 h-32 bg-indigo-500 rounded-full blur-3xl"></div>
                                        </div>
                                        <div className="relative z-10">
                                            <p className="text-[10px] uppercase text-white/40 font-bold tracking-[0.2em] mb-4">Gasto Total Per√≠odo</p>
                                            <div className="flex items-end gap-3">
                                                <h2 className="text-4xl font-extrabold tracking-tight">{formatARS(totals.gastos)}</h2>
                                                {comparisonData.prevGastos > 0 && (
                                                    <div className={`mb-1.5 flex items-center gap-1 px-2 py-0.5 rounded-lg text-[10px] font-bold ${comparisonData.gastosPct <= 0 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-rose-500/20 text-rose-400'}`}>
                                                        {comparisonData.gastosPct <= 0 ? '‚Üò' : '‚Üó'} {Math.abs(comparisonData.gastosPct).toFixed(0)}%
                                                    </div>
                                                )}
                                            </div>
                                            <p className="text-xs text-white/30 mt-2">vs. {comparisonData.labelB} ({formatARS(comparisonData.prevGastos)})</p>
                                        </div>
                                    </div>

                                    <div className="glass p-6 rounded-3xl flex flex-col justify-between">
                                        <div>
                                            <p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Balance</p>
                                            <p className={`text-xl font-bold ${totals.balance >= 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{formatARS(totals.balance)}</p>
                                        </div>
                                        <div className="h-1 w-full bg-white/5 rounded-full mt-4 overflow-hidden">
                                            <div className="h-full bg-indigo-500" style={{ width: '65%' }}></div>
                                        </div>
                                    </div>

                                    <div className="glass p-6 rounded-3xl flex flex-col justify-between">
                                        <div>
                                            <p className="text-[10px] uppercase text-white/40 font-bold tracking-wider mb-1">Patrimonio</p>
                                            <p className="text-xl font-bold text-blue-400">{formatARS(totals.patrimonio)}</p>
                                        </div>
                                        <div className="flex -space-x-2 mt-4">
                                            {[1, 2, 3].map(i => <div key={i} className="w-6 h-6 rounded-full border-2 border-slate-900 bg-indigo-500/20 flex items-center justify-center text-[8px]">‚≠ê</div>)}
                                        </div>
                                    </div>
                                </div>

                                {/* FILA MEDIA: GR√ÅFICO CIRCULAR + MIS TARJETAS */}
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="md:col-span-1 glass p-6 rounded-3xl flex flex-col items-center">
                                        <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-6 w-full">Distribuci√≥n de Gastos</h3>
                                        <div className="relative w-full aspect-square max-w-[200px]">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={pieData} cx="50%" cy="50%" innerRadius={65} outerRadius={85} paddingAngle={8} dataKey="value" stroke="none">
                                                        {pieData.map((entry, i) => <Cell key={i} fill={entry.color} cornerRadius={10} />)}
                                                    </Pie>
                                                </PieChart>
                                            </ResponsiveContainer>
                                            <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                                <p className="text-[10px] text-white/30 uppercase font-bold tracking-tighter">Total</p>
                                                <p className="text-lg font-black tracking-tight">{formatARS(totals.gastos).replace('$', '').split(',')[0]}</p>
                                            </div>
                                        </div>
                                        <div className="mt-6 w-full space-y-2">
                                            {pieData.map((d, i) => (
                                                <div key={i} className="flex justify-between items-center text-[10px]">
                                                    <span className="flex items-center gap-2 text-white/50"><div className="w-2 h-2 rounded-full" style={{ background: d.color }}></div> {d.name}</span>
                                                    <span className="font-bold">{formatARS(d.value)}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="md:col-span-2 space-y-6">
                                        {/* TARJETAS VISUALES */}
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            {MEDIOS_PAGO.filter(m => m.id === 'visa' || m.id === 'mastercard').map(card => {
                                                const cardDebt = byPilar.tarjetas.filter(t => t.metodoPago === card.id).reduce((s, t) => s + t.monto, 0);
                                                return (
                                                    <div key={card.id} className="relative h-40 rounded-2xl p-5 overflow-hidden group border border-white/10 shadow-2xl" style={{ background: card.id === 'visa' ? 'linear-gradient(135deg, #1e1b4b 0%, #312e81 100%)' : 'linear-gradient(135deg, #4c1d95 0%, #6d28d9 100%)' }}>
                                                        <div className="absolute -top-10 -right-10 w-32 h-32 bg-white/5 rounded-full blur-2xl group-hover:scale-150 transition-transform duration-1000"></div>
                                                        <div className="relative z-10 h-full flex flex-col justify-between">
                                                            <div className="flex justify-between items-start">
                                                                <span className="text-xl">{card.icon}</span>
                                                                <span className="text-[10px] font-bold tracking-widest text-white/40 uppercase">{card.nombre}</span>
                                                            </div>
                                                            <div>
                                                                <p className="text-[10px] text-white/40 mb-1">Deuda Acumulada</p>
                                                                <p className="text-2xl font-bold tracking-tight">{formatARS(cardDebt)}</p>
                                                            </div>
                                                            <div className="flex justify-between items-center">
                                                                <p className="text-[8px] font-mono tracking-widest text-white/20">**** **** **** 1234</p>
                                                                <div className="w-8 h-5 bg-white/20 rounded-md backdrop-blur-md border border-white/10"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {/* √öLTIMOS MOVIMIENTOS DASHBOARD */}
                                        <div className="glass p-6 rounded-3xl">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider">√öltimos Movimientos</h3>
                                                <button onClick={() => setActiveTab('gastos')} className="text-[10px] text-indigo-400 font-bold hover:underline">Ver todos</button>
                                            </div>
                                            {renderList(filteredByTime.slice(0, 4))}
                                        </div>
                                    </div>
                                </div>

                                {/* FILA INFERIOR: GR√ÅFICO DE TENDENCIA */}
                                <div className="glass p-6 rounded-3xl">
                                    <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-6">Tendencia de Gastos</h3>
                                    <div className="h-[250px] w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={trendData}>
                                                <defs>
                                                    <linearGradient id="colorWave" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3} />
                                                        <stop offset="95%" stopColor="#6366f1" stopOpacity={0} />
                                                    </linearGradient>
                                                </defs>
                                                <XAxis dataKey="fecha" hide />
                                                <YAxis hide />
                                                <Tooltip
                                                    content={({ active, payload }) => {
                                                        if (active && payload && payload.length) {
                                                            return (
                                                                <div className="glass-dark p-3 rounded-xl border border-white/10">
                                                                    <p className="text-[10px] text-white/40 mb-1">{payload[0].payload.fecha}</p>
                                                                    <p className="text-sm font-bold text-indigo-400">Gasto: {formatARS(payload[0].value)}</p>
                                                                </div>
                                                            );
                                                        }
                                                        return null;
                                                    }}
                                                />
                                                <Area type="monotone" dataKey="gastos" stroke="#6366f1" strokeWidth={3} fillOpacity={1} fill="url(#colorWave)" />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* SECCIONES ESPEC√çFICAS CON DASHBOARD INTERNO */}
                        {['gastos', 'ahorro', 'inversiones', 'ingresos'].includes(activeTab) && (
                            <div className="space-y-8 animate-fade">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl bg-white/5 border border-white/10">
                                            {PILARES[activeTab].icon}
                                        </div>
                                        <div>
                                            <h2 className="text-2xl font-black tracking-tight text-white">{PILARES[activeTab].nombre}</h2>
                                            <p className="text-xs text-white/30 font-medium">Gesti√≥n detallada de {PILARES[activeTab].nombre.toLowerCase()}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => { resetForm(); setFormData({ ...formData, seccion: activeTab }); setShowModal(true); }} className="bg-indigo-600 hover:bg-indigo-700 px-6 py-3 rounded-2xl font-black text-xs transition-all flex items-center gap-3 shadow-lg shadow-indigo-600/20 active:scale-95">
                                        <span className="text-lg">+</span> Nuevo Registro
                                    </button>
                                </div>
                                {(() => {
                                    const items = byPilar[activeTab] || [];
                                    const total = items.reduce((s, t) => s + (t.monto || 0), 0);
                                    const subDist = {};
                                    items.forEach(t => { subDist[t.subcategoria] = (subDist[t.subcategoria] || 0) + (t.monto || 0); });
                                    const pieSubData = Object.entries(subDist).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                                    const colors = ['#818cf8', '#6366f1', '#4338ca', '#3730a3', '#312e81', '#1e1b4b'];
                                    return (
                                        <>
                                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                                <div className="glass p-6 rounded-3xl border border-white/10 relative overflow-hidden group">
                                                    <div className="absolute top-0 right-0 p-8 opacity-5"><p className="text-8xl font-black">{PILARES[activeTab].icon}</p></div>
                                                    <p className="text-[10px] uppercase text-white/40 font-black tracking-widest mb-4">Total {activeTab}</p>
                                                    <h3 className="text-4xl font-black text-white mb-2">{formatARS(total)}</h3>
                                                    <p className="text-xs text-white/30 font-medium">{items.length} movimientos</p>
                                                </div>
                                                <div className="md:col-span-2 glass p-6 rounded-3xl border border-white/10 flex flex-col md:flex-row items-center gap-8">
                                                    <div className="relative w-32 h-32 shrink-0">
                                                        <ResponsiveContainer width="100%" height="100%">
                                                            <PieChart>
                                                                <Pie data={pieSubData} cx="50%" cy="50%" innerRadius={40} outerRadius={55} paddingAngle={4} dataKey="value" stroke="none">
                                                                    {pieSubData.map((entry, i) => <Cell key={i} fill={colors[i % colors.length]} cornerRadius={6} />)}
                                                                </Pie>
                                                            </PieChart>
                                                        </ResponsiveContainer>
                                                    </div>
                                                    <div className="flex-1 w-full space-y-2">
                                                        {pieSubData.slice(0, 3).map((d, i) => (
                                                            <div key={i} className="space-y-1">
                                                                <div className="flex justify-between text-[10px] font-bold">
                                                                    <span className="text-white/60">{d.name}</span>
                                                                    <span className="text-white">{total > 0 ? ((d.value / total) * 100).toFixed(0) : 0}%</span>
                                                                </div>
                                                                <div className="h-1 w-full bg-white/5 rounded-full overflow-hidden">
                                                                    <div className="h-full rounded-full transition-all duration-1000" style={{ width: `${total > 0 ? (d.value / total) * 100 : 0}%`, background: colors[i % colors.length] }}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="glass p-6 rounded-3xl border border-white/5">
                                                <h3 className="text-xs uppercase text-white/40 font-bold tracking-wider mb-4">Detalle de {PILARES[activeTab].nombre}</h3>
                                                {renderList(items)}
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        )}

                        {/* TARJETAS PREMIUM */}
                        {activeTab === 'tarjetas' && (
                            <div className="space-y-8 animate-fade">
                                {/* HEADER */}
                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl bg-white/5 border border-white/10 text-purple-400">
                                            <Icons.Tarjeta />
                                        </div>
                                        <div>
                                            <h2 className="text-2xl font-black tracking-tight text-white">Tarjetas</h2>
                                            <p className="text-xs text-white/30 font-medium">Cronograma de vencimientos y deudas</p>
                                        </div>
                                    </div>
                                    <button onClick={() => { resetForm(); setFormData({ ...formData, seccion: 'tarjetas' }); setShowModal(true); }} className="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-2xl font-black text-xs transition-all flex items-center gap-3 shadow-lg shadow-purple-600/20 active:scale-95">
                                        <span className="text-lg">+</span> Nuevo Consumo
                                    </button>
                                </div>

                                {(() => {
                                    const items = byPilar.tarjetas || [];
                                    const total = items.reduce((s, t) => s + (t.monto || 0), 0);

                                    // Deuda por m√©todo (Visa, MasterCard, etc.)
                                    const cardDist = {};
                                    items.forEach(t => {
                                        const method = MEDIOS_PAGO.find(m => m.id === t.metodoPago)?.nombre || 'Otros';
                                        cardDist[method] = (cardDist[method] || 0) + (t.monto || 0);
                                    });
                                    const pieCardData = Object.entries(cardDist).map(([name, value]) => ({ name, value }))
                                        .sort((a, b) => b.value - a.value);

                                    const colors = ['#a78bfa', '#8b5cf6', '#7c3aed', '#6d28d9', '#5b21b6'];

                                    return (
                                        <>
                                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                                <div className="md:col-span-1 glass p-6 rounded-3xl border border-white/10 flex flex-col justify-center">
                                                    <p className="text-[10px] uppercase text-white/40 font-black tracking-widest mb-4">Deuda Total</p>
                                                    <h3 className="text-3xl font-black text-purple-400 mb-2">{formatARS(total)}</h3>
                                                    <p className="text-[10px] text-white/20 font-medium">Suma de todos los ciclos</p>
                                                </div>

                                                <div className="md:col-span-3 glass p-6 rounded-3xl border border-white/10 flex flex-col md:flex-row items-center gap-8">
                                                    <div className="relative w-32 h-32 shrink-0">
                                                        <ResponsiveContainer width="100%" height="100%">
                                                            <PieChart>
                                                                <Pie data={pieCardData} cx="50%" cy="50%" innerRadius={40} outerRadius={55} paddingAngle={4} dataKey="value" stroke="none">
                                                                    {pieCardData.map((entry, i) => <Cell key={i} fill={colors[i % colors.length]} cornerRadius={6} />)}
                                                                </Pie>
                                                            </PieChart>
                                                        </ResponsiveContainer>
                                                    </div>
                                                    <div className="flex-1 w-full grid grid-cols-2 gap-4">
                                                        {pieCardData.slice(0, 4).map((d, i) => (
                                                            <div key={i} className="flex flex-col gap-1">
                                                                <div className="flex justify-between text-[10px] font-bold">
                                                                    <span className="text-white/60">{d.name}</span>
                                                                    <span className="text-white">{formatARS(d.value)}</span>
                                                                </div>
                                                                <div className="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                                                                    <div className="h-full rounded-full transition-all duration-1000" style={{ width: `${total > 0 ? (d.value / total) * 100 : 0}%`, background: colors[i % colors.length] }}></div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="glass p-8 rounded-[2rem] border border-white/5">
                                                <h3 className="text-lg font-black text-white mb-6">Detalle por Emisor</h3>
                                                {MEDIOS_PAGO.filter(m => m.id !== 'efectivo' && m.id !== 'debito').map(metodo => {
                                                    const mItems = items.filter(t => t.metodoPago === metodo.id);
                                                    if (mItems.length === 0) return null;
                                                    return (
                                                        <div key={metodo.id} className="mb-8 last:mb-0">
                                                            <div className="flex items-center gap-3 mb-4 opacity-70">
                                                                <span className="text-xl">{metodo.icon}</span>
                                                                <h4 className="text-xs uppercase font-black tracking-widest">{metodo.nombre}</h4>
                                                            </div>
                                                            {renderList(mItems, true)}
                                                        </div>
                                                    );
                                                })}
                                                {items.length === 0 && <p className="text-center py-12 text-white/20">Sin deudas registradas</p>}
                                            </div>
                                        </>
                                    );
                                })()}
                            </div>
                        )}

                        {/* AN√ÅLISIS PREMIUM */}
                        {activeTab === 'analisis' && (
                            <div className="space-y-8 animate-fade">
                                <div className="flex items-center gap-4 mb-6">
                                    <div className="w-12 h-12 rounded-2xl flex items-center justify-center text-2xl bg-white/5 border border-white/10 text-indigo-400">
                                        <Icons.Trend />
                                    </div>
                                    <div>
                                        <h2 className="text-2xl font-black tracking-tight text-white">An√°lisis Avanzado</h2>
                                        <p className="text-xs text-white/30 font-medium">M√©tricas globales y comportamiento</p>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="glass p-8 rounded-[2rem] border border-white/10">
                                        <h3 className="text-xs uppercase text-white/40 font-black tracking-widest mb-8">Distribuci√≥n por Categor√≠a</h3>
                                        <div className="h-[300px]">
                                            {pieData.length > 0 ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <PieChart>
                                                        <Pie data={pieData} cx="50%" cy="50%" innerRadius={70} outerRadius={100} paddingAngle={5} dataKey="value" stroke="none">
                                                            {pieData.map((entry, i) => <Cell key={i} fill={entry.color} cornerRadius={10} />)}
                                                        </Pie>
                                                        <Tooltip formatter={(v) => formatARS(v)} contentStyle={{ background: '#121421', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px', boxShadow: '0 20px 40px rgba(0,0,0,0.5)' }} />
                                                    </PieChart>
                                                </ResponsiveContainer>
                                            ) : <p className="text-center py-12 text-white/20">Sin datos</p>}
                                        </div>
                                    </div>

                                    <div className="glass p-8 rounded-[2rem] border border-white/10">
                                        <h3 className="text-xs uppercase text-white/40 font-black tracking-widest mb-8">Ingresos vs Gastos</h3>
                                        <div className="h-[300px]">
                                            {trendData.length > 0 ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <AreaChart data={trendData}>
                                                        <defs>
                                                            <linearGradient id="colorIng2" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.3} /><stop offset="95%" stopColor="#10b981" stopOpacity={0} /></linearGradient>
                                                            <linearGradient id="colorGas2" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#f43f5e" stopOpacity={0.3} /><stop offset="95%" stopColor="#f43f5e" stopOpacity={0} /></linearGradient>
                                                        </defs>
                                                        <XAxis dataKey="fecha" hide />
                                                        <YAxis hide />
                                                        <Tooltip formatter={(v) => formatARS(v)} contentStyle={{ background: '#121421', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '16px' }} />
                                                        <Area type="monotone" dataKey="ingresos" stroke="#10b981" fill="url(#colorIng2)" strokeWidth={3} />
                                                        <Area type="monotone" dataKey="gastos" stroke="#f43f5e" fill="url(#colorGas2)" strokeWidth={3} />
                                                    </AreaChart>
                                                </ResponsiveContainer>
                                            ) : <p className="text-center py-12 text-white/20">Sin datos</p>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {/* MODALES GLOBALES */}
                        {isEditingStartAmount && (
                            <div className="fixed inset-0 z-[500] flex items-center justify-center p-4">
                                <div className="absolute inset-0 bg-black/90 backdrop-blur-2xl" onClick={() => setIsEditingStartAmount(false)}></div>
                                <div className="glass p-8 rounded-[2.5rem] max-w-sm w-full relative z-[501] animate-pop shadow-[0_40px_100px_rgba(0,0,0,0.9)]" onClick={e => e.stopPropagation()}>
                                    <div className="w-16 h-16 bg-indigo-600/20 rounded-2xl flex items-center justify-center text-3xl mb-6 mx-auto">üí∞</div>
                                    <h3 className="text-xl font-black text-center mb-2">Configurar Saldo Total</h3>
                                    <p className="text-white/40 text-[10px] text-center uppercase font-bold tracking-widest mb-8">¬øCon cu√°nta plata empez√°s hoy?</p>

                                    <div className="bg-white/5 p-6 rounded-3xl border border-white/10 mb-8">
                                        <div className="flex items-center gap-3">
                                            <span className="text-2xl font-bold text-white/40">$</span>
                                            <input
                                                autoFocus
                                                type="number"
                                                value={tempStartAmount}
                                                onChange={e => setTempStartAmount(e.target.value)}
                                                className="bg-transparent border-none text-4xl font-black text-white outline-none w-full"
                                                placeholder="0"
                                                onKeyDown={e => e.key === 'Enter' && (setSessionStartAmount(parseFloat(tempStartAmount) || 0), setIsEditingStartAmount(false))}
                                            />
                                        </div>
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            onClick={() => setIsEditingStartAmount(false)}
                                            className="flex-1 py-4 rounded-2xl border border-white/10 hover:bg-white/5 font-bold transition-all text-sm"
                                        >
                                            Cancelar
                                        </button>
                                        <button
                                            onClick={() => { setSessionStartAmount(parseFloat(tempStartAmount) || 0); setIsEditingStartAmount(false); }}
                                            className="flex-1 py-4 rounded-2xl bg-indigo-600 hover:bg-indigo-700 font-bold transition-all text-sm shadow-[0_10px_30px_rgba(79,70,229,0.3)]"
                                        >
                                            Confirmar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* FAB */}
                    <button onClick={() => { resetForm(); setShowModal(true); }} className="fixed bottom-24 md:bottom-8 left-6 w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl shadow-lg shadow-indigo-500/30 flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-40">
                        <Icons.Plus />
                    </button>

                    {/* TAB BAR MOBILE */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 glass-dark p-2 flex justify-around z-40">
                        {TABS.slice(0, 5).map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all ${activeTab === tab.id ? 'text-white' : 'text-white/40'}`}>
                                <span className="text-lg">{tab.icon}</span>
                                <span className="text-[10px] font-medium">{tab.nombre}</span>
                            </button>
                        ))}
                    </nav>

                    {/* MODAL */}
                    {showModal && (
                        <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4 bg-black/60 backdrop-blur-sm animate-fade" onClick={resetForm}>
                            <div className="glass w-full md:max-w-lg md:rounded-3xl rounded-t-3xl p-8 animate-slide max-h-[90vh] overflow-y-auto custom-scroll" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold">{editingId ? '‚úèÔ∏è Editar' : '‚ûï Nuevo'} Movimiento</h2>
                                    <button onClick={resetForm} className="p-2 hover:bg-white/10 rounded-xl transition-all"><Icons.X /></button>
                                </div>
                                <form onSubmit={handleSave} className="space-y-5">
                                    {/* SECCI√ìN 1: CLASIFICACI√ìN */}
                                    <div className="pb-5 border-b border-white/10">
                                        <label className="text-[10px] uppercase text-indigo-400 font-bold tracking-wider block mb-4">Clasificaci√≥n</label>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Producto / Concepto</label>
                                                <input type="text" required placeholder="Ej: Caf√©" value={formData.articulo} onChange={e => setFormData({ ...formData, articulo: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Tienda / Lugar</label>
                                                <input type="text" placeholder="Ej: Starbucks" value={formData.tienda} onChange={e => setFormData({ ...formData, tienda: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Monto (ARS)</label>
                                                <input type="number" required inputMode="decimal" placeholder="0" value={formData.monto} onChange={e => setFormData({ ...formData, monto: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all font-mono" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Fecha</label>
                                                <input type="date" required value={formData.fecha} onChange={e => setFormData({ ...formData, fecha: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none focus:border-indigo-500 transition-all" />
                                            </div>
                                        </div>
                                        <div className="mb-4">
                                            <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Pilar</label>
                                            <select value={formData.seccion} onChange={e => setFormData({ ...formData, seccion: e.target.value, subcategoria: PILARES[e.target.value].subcategorias[0] })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none appearance-none cursor-pointer focus:border-indigo-500 transition-all">
                                                {Object.entries(PILARES).map(([key, val]) => <option key={key} value={key} className="bg-slate-900">{val.icon} {val.nombre}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Subcategor√≠a</label>
                                            <select value={formData.subcategoria} onChange={e => setFormData({ ...formData, subcategoria: e.target.value })} className="w-full p-4 bg-white/5 border border-white/10 rounded-xl outline-none appearance-none cursor-pointer focus:border-indigo-500 transition-all">
                                                {PILARES[formData.seccion].subcategorias.map(s => <option key={s} value={s} className="bg-slate-900">{s}</option>)}
                                            </select>
                                        </div>
                                    </div>

                                    {/* SECCI√ìN 2: DETALLES DE PAGO */}
                                    <div className="border-t border-white/10 pt-5 mt-5">
                                        <label className="text-[10px] uppercase text-indigo-400 font-bold tracking-wider block mb-4">M√©todo de Pago</label>
                                        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                                            {MEDIOS_PAGO.map(m => (
                                                <button key={m.id} type="button" onClick={() => setFormData({ ...formData, metodoPago: m.id })} className={`flex items-center gap-2 p-3 rounded-xl border transition-all text-xs ${formData.metodoPago === m.id ? 'bg-indigo-600/20 border-indigo-500 text-white' : 'bg-white/5 border-white/10 text-white/40 hover:bg-white/10'}`}>
                                                    <span>{m.icon}</span>
                                                    <span className="truncate">{m.nombre}</span>
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* CAMPOS CONDICIONALES TARJETAS (SOLO SI NO ES EFECTIVO) */}
                                    {formData.metodoPago !== 'efectivo' && (
                                        <div className="glass p-4 rounded-xl space-y-4 animate-fade">
                                            <p className="text-xs text-white/60 flex items-center gap-2">üí≥ Configuraci√≥n de Cuotas</p>
                                            <div className="grid grid-cols-3 gap-3">
                                                <div>
                                                    <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Cuotas</label>
                                                    <select value={formData.cuotas} onChange={e => setFormData({ ...formData, cuotas: e.target.value })} className="w-full p-3 bg-slate-800 border border-white/10 rounded-lg outline-none focus:border-purple-500 transition-all text-center appearance-none cursor-pointer">
                                                        {[...Array(12)].map((_, i) => <option key={i + 1} value={i + 1}>{i + 1}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">Cuota Actual</label>
                                                    <input type="number" inputMode="numeric" placeholder="1" value={formData.cuotaActual} onChange={e => setFormData({ ...formData, cuotaActual: e.target.value })} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:border-purple-500 transition-all text-center" />
                                                </div>
                                                <div>
                                                    <label className="text-[10px] uppercase text-white/40 font-bold tracking-wider block mb-2">D√≠a Venc.</label>
                                                    <input type="number" inputMode="numeric" placeholder="10" value={formData.diaVencimiento} onChange={e => setFormData({ ...formData, diaVencimiento: e.target.value })} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:border-purple-500 transition-all text-center" />
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    <button type="submit" className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all active:scale-[0.98]">
                                        {editingId ? 'Actualizar' : 'Guardar'} Movimiento
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>